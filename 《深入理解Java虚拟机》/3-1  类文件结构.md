#  3-1  类文件结构



##  6.3  Class 类文件的结构

> 注意：任何一个 Class 文件都对应着唯一一个类或接口的定义信息，但反过来说，类或接口并不一定都得定义在文件里（比如类或接口也可以通过类加载器直接生成）。

Class 文件是一组以 8 位字节为基础单位的二进制流，采用一种类似 C 语言结构体的伪结构存储数据，只有两种类型：无符号数和表。

- 无符号数

基本数据类型，以 u1、u2、u4、u8 分别代表 1、2、4、8 个字节的无符号数，可以用来描述数字、索引引用、数量值或按照 UTF-8 编码构成字符串值。

- 表

由多个无符号数或其他表作为数据项构成的复合数据类型，习惯以 “_info” 结尾。用于描述有层次关系的复合结构的数据。

Class 文件格式如下图所示：

![class_file_format](https://github.com/JiaoXR/ReadingNotes/tree/master/pics/JVM/class_file_format.png)

TestClass 类及编译后的字节码文件如下：

![TestClass](https://github.com/JiaoXR/ReadingNotes/tree/master/pics/JVM/TestClass.png)



![byte_code](https://github.com/JiaoXR/ReadingNotes/tree/master/pics/JVM/byte_code.png)



javap 反编译的信息如下图：

![javap_verbose](https://github.com/JiaoXR/ReadingNotes/tree/master/pics/JVM/javap_verbose.png)



> 注意：Class 的结构没有任何分隔符号，无论顺序还是数量，甚至数据存储的字节序（Byte Ordering，Class 文件中字节序为 Big-Endian）这样的细节都被严格限定，哪个字节代表什么，长度多少，先后顺序都不允许改变。

###  6.3.1  魔数与 Class 文件的版本

- Class 文件的头 4 个字节称为魔数（Magic Number），唯一的作用是确定这个文件是否为一个能被虚拟机接受的 Class 文件，固定为“0xCAFEBABE”（使用魔数而非扩展名的主要原因是安全，扩展名可随意改动）。
- 第 5、6 个字节为次版本号，第 7、8 个字节为主版本号。高版本的 JDK 能向下兼容以前版本的 Class 文件，但不能运行以后版本的 Class 文件。



###  6.3.2  常量池

- 常量池可理解为 Class 文件的资源仓库，是 Class 文件结构中与其他项目关联最多的数据类型，也是占用 Class 文件空间最大的数据项目之一。因其数量不固定，所以入口有一项 u2 类型的数据表示其容量。

> 注意：Class 文件中，只有常量池容量计数是从 1 开始的。

常量池主要存放两大类常量（常量池中每一项常量都是一个表）：

- 字面量（Literal）
  - 比如文本字符串、声明为 final 的常量值等
- 符号引用（Symbolic References）
  - 类和接口的全限定名（Fully Qualified Name）
  - 字段的名称和描述符（Descriptor）
  - 方法的名称和描述符



- JDK 1.7 中常量池共有 14 种不同的表结构数据。这些表结构的第一位是 u1 类型的标志位，代表当前常量的类型，具体如下图所示：

![class_file_constant_pool](https://github.com/JiaoXR/ReadingNotes/tree/master/pics/JVM/class_file_constant_pool.png)



- 之所以说常量池是最繁琐的数据就，是因为这 14 种常量类型均有自己的结构。分别如下图所示（可以对比前面 javap 反编译的结果）：

![class_file_constant_pool_detail1](https://github.com/JiaoXR/ReadingNotes/tree/master/pics/JVM/class_file_constant_pool_detail1.png)

![class_file_constant_pool_detail2](https://github.com/JiaoXR/ReadingNotes/tree/master/pics/JVM/class_file_constant_pool_detail2.png)



- 字节码文件解读（）

  - 0xCAFE, 0xBABE : 魔数

  - 0x0000 : 次版本号

  - 0x0034 : 主版本号（十进制为：3 * 16 + 4 = 52）

  - 0x0013 : 常量池数量（十进制为：1 * 16 + 3 = 19）

  - 第 1 项：0x0A（10，CONSTANT_Methodref_info）；0x0004（指向第 4 项的类描述符），0x000F（指向第 15 项的名称及类型描述符），CONSTANT_Methodref_info 表结构如下：

    | 项目  | 类型 | 描述                                                |
    | ----- | ---- | --------------------------------------------------- |
    | tag   | u1   | 值为 10                                             |
    | index | u2   | 指向声明方法的类描述符 CONSTANT_Class_info 的索引项 |
    | index | u2   | 指向名称及类型描述符 CONSTANT_NameAndType 的索引项  |

  - 第 2 项：0x09（9，CONSTANT_Fieldref_info），0x0003（指向第 3 项类描述符），0x0010（指向第 16 项的名称及类型描述符），CONSTANT_Fieldref_info 表结构如下：

    | 项目  | 类型 | 描述                                                      |
    | ----- | ---- | --------------------------------------------------------- |
    | tag   | u1   | 值为 9                                                    |
    | index | u2   | 指向声明字段的类或接口描述符 CONSTANT_Class_info 的索引项 |
    | index | u2   | 指向字段描述符 CONSTANT_NameAndType 的索引项              |

  - 第 3 项：0x07（7，CONSTANT_Class_info），0x0011（指向第 17 项全限定名常量项），CONSTANT_Class_info 表结构如下：

    | 项目  | 类型 | 描述                     |
    | ----- | ---- | ------------------------ |
    | tag   | u1   | 值为 7                   |
    | index | u2   | 指向全限定名常量项的索引 |

  - 第 4 项：0x07（7，CONSTANT_Class_info），0x0012（指向第 18 项全限定名常量项）

  - 第 5 项：0x01（1，CONSTANT_Utf8_info），0x0001（占用 1 个字节），6D（字符 “m”）

  - 第 6 项：0x01（1，CONSTANT_Utf8_info），0x0001（占用 1 个字节），49（字符 “I”）

  - 第 7 项：0x01（1，CONSTANT_Utf8_info），0x0006（占用 6 个字节），3C 69 6E 69 74 3E（字符 “<init>”）

  - 第 8 项：0x01（1，CONSTANT_Utf8_info），0x0003（占用 3 个字节），28 29 56（字符 “()”）

  - 第 9 项：0x01（1，CONSTANT_Utf8_info），0x0004（占用 4 个字节），43 6F 64 65（字符 “Code”）

  - 第 10 项：0x01（1，CONSTANT_Utf8_info），0x000F（占用 15 个字节），4C 69 6E 65 4E 75 6D 62 65 72 54 61 62 6C 65（字符 “LineNumberTable”）

  - 第 11 项：0x01（1，CONSTANT_Utf8_info），0x0003（占用 3 个字节），69 6E 63（字符 “inc”）

  - 第 12 项：0x01（1，CONSTANT_Utf8_info），0x0003（占用 3 个字节），28 29 49（字符 “()I”）

  - 第 13 项：0x01（1，CONSTANT_Utf8_info），0x000A（占用10个字节），53 6F 75 72 63 65 46 69 6C 65（字符 “SourceFile”）

  - 第 14 项：0x01（1，CONSTANT_Utf8_info），0x000E（占用 14 个字节），54 65 73 74 43 6C 61 73 73 2E 6A 61 76 61（字符 “TestClass.java”）

  - 第 15 项：0x0C（12，CONSTANT_NameAndType_info），0x0007（指向第 7 项名称常量项）， 0x0008（指向第 8 项描述符常量项），CONSTANT_NameAndType_info 表结构如下：

    | 项目  | 类型 | 描述                             |
    | ----- | ---- | -------------------------------- |
    | tag   | u1   | 值为 12                          |
    | index | u2   | 指向该字段或方法名称常量项的索引 |
    | index | u2   | 指向该字段或方法描述常量项的索引 |

  - 第 16 项：0x0C（12，CONSTANT_NameAndType_info），0x0005（指向第 5 项名称常量项）， 0x0006（指向第 6 项描述符常量项）
  - 第 17 项：0x01（1，CONSTANT_Utf8_info），0x001B（占用 27 个字节），63 6F 6D 2F 6A 61 78 65 72 2F 65 78 61 6D 70 6C 65 2F 54 65 73 74 43 6C 61 73 73（字符 “com/jaxer/example/TestClass”）
  - 第 18 项：0x01（1，CONSTANT_Utf8_info），0x0010（占用 16 个字节），6A 61 76 61 2F 6C 61 6E 67 2F 4F 62 6A 65 63 74（字符 “java/lang/Object”）





