#  3-2  虚拟机类加载机制

##  7.1  概述

- 虚拟机把描述类的数据从 Class 文件加载到内存，并对数据进行校验、转换解析和初始化，最终形成可以被虚拟机直接使用的 Java 类型，这就是虚拟机的类加载机制。

- 在 Java 语言里面，类型的加载、连接和初始化过程都是在程序运行期间完成，这虽然会令类加载时增量一些性能开销，但是会为 Java 应用程序提供高度的灵活性。

##  7.2  类加载的时机

类从被加载到虚拟机内存中开始，到卸载出内存为止，它的整个生命周期包括：加载（Loading）、验证（Verification）、准备（Preparation）、解析（Resolution）、初始化（Initialization）、使用（Using）和卸载（UNloading）7 个阶段。其中验证、准备、解析 3 个部分统称为连接（Linking）。



JVM 规范没有强制约束类加载的时机，但严格规定了有且只有 5 种情况必须立即对类进行初始化：

1. 遇到 new、getstatic、putstatic 和 invokestatic指令（场景：使用 new 实例化对象，读取/设置类的静态字段等）；
2. 使用 `java.lang.reflect` 包的方法对类进行反射调用时如果类没有进行过初始化；
3. 初始化时发现父类还没有进行初始化；
4. 虚拟机启动指定的主类（包含 main 方法的类）；
5. 动态语言中 MethodHandle 实例最后解析结果 REF_getStatic 等的方法句柄对应的类没有初始化时；

##  7.3  类加载的过程

###  7.3.1  加载

加载阶段，虚拟机要完成的事情：

1. 通过一个类的全限定名来获取定义此类的二进制字节流；
2. 将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构；
3. 在内存中生成一个代表这个类的 `java.lang.Class` 对象，作为方法区这个类的各种数据的访问入口。

###  7.3.2  验证

- 验证是连接阶段的第一步，目的是确保 Class 文件的字节流中包含的信息符合当前虚拟机的要求，且不会危害虚拟机自身的安全。
- 验证是虚拟机对自身保护的一项重要工作，这个阶段是否严谨，直接决定了 JVM 是否能承受恶意代码的攻击。
- 验证阶段大致上会完成 4 个阶段的检验动作
  - 文件格式验证（是否符合 Class 文件格式等）
  - 元数据验证（确保符合 Java 语言规范）
  - 字节码验证（该阶段最复杂，主要是确定语义合法、符合逻辑）
  - 符号引用验证（目的是确保解析动作能正常执行）

###  7.3.3  准备

- 正式为变量分配内存并设置类变量初始值的阶段，这些变量所使用的内存都将在方法区中进行分配。
  - 此时分配内存的仅包括类变量（`static` 修饰的变量）；
  - 初始值“通常情况”下是数据类型的零值，赋值动作在初始化阶段执行；但若为 `static final` 则直接赋值。

###  7.3.4  解析

- 解析阶段是虚拟机将常量池内的符号引用（如 CONSTANT_Class_info、CONSTANT_Fieldref_info、CONSTANT_Methodref_info 等）替换为直接引用的过程；

###  7.3.5  初始化

- 类加载过程的最后一步，真正开始执行类中定义的 Java 程序代码（或者说是字节码）；





















